<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TecoScan</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; background: #f2f2f2; }
    h1 { background: #2c3e50; color: white; padding: 15px; margin: 0; }
    h2 { margin-top: 20px; }
    video { width: 90%; max-width: 400px; border: 2px solid #333; border-radius: 8px; margin: 10px auto; display: block; }
    input { font-size: 1.2em; padding: 8px; margin: 10px; width: 80%; max-width: 300px; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 6px; background: #3498db; color: white; font-size: 1em; cursor: pointer; }
    button:hover { background: #2980b9; }
    ul { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; margin: 10px; }
    li { background: white; padding: 6px; margin: 4px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .delete-btn { background: red; color: white; border: none; border-radius: 5px; padding: 2px 8px; cursor: pointer; }
    .delete-btn:hover { background: darkred; }
    label { display: block; margin: 10px; font-size: 0.9em; }
    footer { margin-top: 20px; font-size: 0.8em; color: #555; }
  </style>
</head>
<body>
  <h1>TecoScan <br><span style="font-size:0.7em;">by pm.foinap</span></h1>

  <video id="video" autoplay></video>
  
  <input type="text" id="manualInput" placeholder="Ingresar etiqueta manualmente">
  <button onclick="addManual()">Agregar</button>

  <label>
    <input type="checkbox" id="allowDuplicates">
    Permitir duplicados
  </label>

  <h2>Lecturas: <span id="count">0</span></h2>
  <ul id="codesList"></ul>

  <button onclick="clearAll()">Eliminar todas</button>
  <button onclick="generateFile()">Generar archivo TXT</button>

  <footer>
    <p>TecoScan - Gestión de stock textil</p>
  </footer>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoElement = document.getElementById('video');
    const codesList = document.getElementById('codesList');
    const manualInput = document.getElementById('manualInput');
    const countSpan = document.getElementById('count');
    const allowDuplicates = document.getElementById('allowDuplicates');
    let codes = [];

    // Sonido al leer
    const beep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

    function updateList() {
      codesList.innerHTML = "";
      codes.forEach((code, index) => {
        const li = document.createElement("li");
        li.textContent = code;
        const delBtn = document.createElement("button");
        delBtn.textContent = "X";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => { codes.splice(index, 1); updateList(); };
        li.appendChild(delBtn);
        codesList.prepend(li); // último arriba
      });
      countSpan.textContent = codes.length;
    }

    function addCode(newCode) {
      if (!allowDuplicates.checked && codes.includes(newCode)) {
        return; // bloquea duplicados
      }
      codes.push(newCode);
      beep.play();
      updateList();
    }

    function addManual() {
      const value = manualInput.value.trim();
      if (value) {
        addCode(value);
        manualInput.value = "";
      }
    }

    function clearAll() {
      codes = [];
      updateList();
    }

    function generateFile() {
      if (codes.length === 0) {
        alert("No hay lecturas para generar.");
        return;
      }
      const blob = new Blob([codes.join("\n")], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "lecturas.txt";
      a.click();
      clearAll(); // limpiar después de generar
    }

    // Activar cámara
    codeReader
      .listVideoInputDevices()
      .then(videoInputDevices => {
        codeReader.decodeFromVideoDevice(videoInputDevices[0].deviceId, videoElement, (result, err) => {
          if (result) addCode(result.text);
        });
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
